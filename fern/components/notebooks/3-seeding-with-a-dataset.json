{
  "cells": [
    {
      "type": "markdown",
      "source": "# \ud83c\udfa8 Data Designer Tutorial: Seeding Synthetic Data Generation with an External Dataset\n\n#### \ud83d\udcda What you'll learn\n\nIn this notebook, we will demonstrate how to seed synthetic data generation in Data Designer with an external dataset.\n\nIf this is your first time using Data Designer, we recommend starting with the [first notebook](https://nvidia-nemo.github.io/DataDesigner/latest/notebooks/1-the-basics/) in this tutorial series."
    },
    {
      "type": "markdown",
      "source": "### \ud83d\udce6 Import Data Designer\n\n- `data_designer.config` provides access to the configuration API.\n\n- `DataDesigner` is the main interface for data generation."
    },
    {
      "type": "markdown",
      "source": "### \u26a1 Colab Setup\n\nRun the cells below to install the dependencies and set up the API key. If you don't have an API key, you can generate one from [build.nvidia.com](https://build.nvidia.com)."
    },
    {
      "type": "code",
      "source": "%%capture\n!pip install -U data-designer",
      "language": "python"
    },
    {
      "type": "code",
      "source": "import getpass\nimport os\n\nfrom google.colab import userdata\n\ntry:\n    os.environ[\"NVIDIA_API_KEY\"] = userdata.get(\"NVIDIA_API_KEY\")\nexcept userdata.SecretNotFoundError:\n    os.environ[\"NVIDIA_API_KEY\"] = getpass.getpass(\"Enter your NVIDIA API key: \")",
      "language": "python"
    },
    {
      "type": "code",
      "source": "import data_designer.config as dd\nfrom data_designer.interface import DataDesigner",
      "language": "python"
    },
    {
      "type": "markdown",
      "source": "### \u2699\ufe0f Initialize the Data Designer interface\n\n- `DataDesigner` is the main object responsible for managing the data generation process.\n\n- When initialized without arguments, the [default model providers](https://nvidia-nemo.github.io/DataDesigner/latest/concepts/models/default-model-settings/) are used."
    },
    {
      "type": "code",
      "source": "data_designer = DataDesigner()",
      "language": "python"
    },
    {
      "type": "markdown",
      "source": "### \ud83c\udf9b\ufe0f Define model configurations\n\n- Each `ModelConfig` defines a model that can be used during the generation process.\n\n- The \"model alias\" is used to reference the model in the Data Designer config (as we will see below).\n\n- The \"model provider\" is the external service that hosts the model (see the [model config](https://nvidia-nemo.github.io/DataDesigner/latest/concepts/models/default-model-settings/) docs for more details).\n\n- By default, we use [build.nvidia.com](https://build.nvidia.com/models) as the model provider."
    },
    {
      "type": "code",
      "source": "# This name is set in the model provider configuration.\nMODEL_PROVIDER = \"nvidia\"\n\n# The model ID is from build.nvidia.com.\nMODEL_ID = \"nvidia/nemotron-3-nano-30b-a3b\"\n\n# We choose this alias to be descriptive for our use case.\nMODEL_ALIAS = \"nemotron-nano-v3\"\n\nmodel_configs = [\n    dd.ModelConfig(\n        alias=MODEL_ALIAS,\n        model=MODEL_ID,\n        provider=MODEL_PROVIDER,\n        inference_parameters=dd.ChatCompletionInferenceParams(\n            temperature=1.0,\n            top_p=1.0,\n            max_tokens=2048,\n            extra_body={\"chat_template_kwargs\": {\"enable_thinking\": False}},\n        ),\n    )\n]",
      "language": "python"
    },
    {
      "type": "markdown",
      "source": "### \ud83c\udfd7\ufe0f Initialize the Data Designer Config Builder\n\n- The Data Designer config defines the dataset schema and generation process.\n\n- The config builder provides an intuitive interface for building this configuration.\n\n- The list of model configs is provided to the builder at initialization."
    },
    {
      "type": "code",
      "source": "config_builder = dd.DataDesignerConfigBuilder(model_configs=model_configs)",
      "language": "python"
    },
    {
      "type": "markdown",
      "source": "## \ud83c\udfe5 Prepare a seed dataset\n\n- For this notebook, we'll create a synthetic dataset of patient notes.\n\n- We will _seed_ the generation process with a [symptom-to-diagnosis dataset](https://huggingface.co/datasets/gretelai/symptom_to_diagnosis).\n\n- We already have the dataset downloaded in the [data](../data) directory of this repository.\n\n<br>\n\n> \ud83c\udf31 **Why use a seed dataset?**\n>\n> - Seed datasets let you steer the generation process by providing context that is specific to your use case.\n>\n> - Seed datasets are also an excellent way to inject real-world diversity into your synthetic data.\n>\n> - During generation, prompt templates can reference any of the seed dataset fields."
    },
    {
      "type": "code",
      "source": "# Download sample dataset from Github\nimport urllib.request\n\nurl = \"https://raw.githubusercontent.com/NVIDIA/GenerativeAIExamples/refs/heads/main/nemo/NeMo-Data-Designer/data/gretelai_symptom_to_diagnosis.csv\"\nlocal_filename, _ = urllib.request.urlretrieve(url, \"gretelai_symptom_to_diagnosis.csv\")\n\n# Seed datasets are passed as reference objects to the config builder.\nseed_source = dd.LocalFileSeedSource(path=local_filename)\n\nconfig_builder.with_seed_dataset(seed_source)",
      "language": "python"
    },
    {
      "type": "markdown",
      "source": "## \ud83c\udfa8 Designing our synthetic patient notes dataset\n\n- The prompt template can reference fields from our seed dataset:\n  - `{{ diagnosis }}` - the medical diagnosis from the seed data\n  - `{{ patient_summary }}` - the symptom description from the seed data"
    },
    {
      "type": "code",
      "source": "config_builder.add_column(\n    dd.SamplerColumnConfig(\n        name=\"patient_sampler\",\n        sampler_type=dd.SamplerType.PERSON_FROM_FAKER,\n        params=dd.PersonFromFakerSamplerParams(),\n    )\n)\n\nconfig_builder.add_column(\n    dd.SamplerColumnConfig(\n        name=\"doctor_sampler\",\n        sampler_type=dd.SamplerType.PERSON_FROM_FAKER,\n        params=dd.PersonFromFakerSamplerParams(),\n    )\n)\n\nconfig_builder.add_column(\n    dd.SamplerColumnConfig(\n        name=\"patient_id\",\n        sampler_type=dd.SamplerType.UUID,\n        params=dd.UUIDSamplerParams(\n            prefix=\"PT-\",\n            short_form=True,\n            uppercase=True,\n        ),\n    )\n)\n\nconfig_builder.add_column(dd.ExpressionColumnConfig(name=\"first_name\", expr=\"{{ patient_sampler.first_name }}\"))\n\nconfig_builder.add_column(dd.ExpressionColumnConfig(name=\"last_name\", expr=\"{{ patient_sampler.last_name }}\"))\n\nconfig_builder.add_column(dd.ExpressionColumnConfig(name=\"dob\", expr=\"{{ patient_sampler.birth_date }}\"))\n\nconfig_builder.add_column(\n    dd.SamplerColumnConfig(\n        name=\"symptom_onset_date\",\n        sampler_type=dd.SamplerType.DATETIME,\n        params=dd.DatetimeSamplerParams(start=\"2024-01-01\", end=\"2024-12-31\"),\n    )\n)\n\nconfig_builder.add_column(\n    dd.SamplerColumnConfig(\n        name=\"date_of_visit\",\n        sampler_type=dd.SamplerType.TIMEDELTA,\n        params=dd.TimeDeltaSamplerParams(dt_min=1, dt_max=30, reference_column_name=\"symptom_onset_date\"),\n    )\n)\n\nconfig_builder.add_column(dd.ExpressionColumnConfig(name=\"physician\", expr=\"Dr. {{ doctor_sampler.last_name }}\"))\n\nconfig_builder.add_column(\n    dd.LLMTextColumnConfig(\n        name=\"physician_notes\",\n        prompt=\"\"\"\\\nYou are a primary-care physician who just had an appointment with {{ first_name }} {{ last_name }},\nwho has been struggling with symptoms from {{ diagnosis }} since {{ symptom_onset_date }}.\nThe date of today's visit is {{ date_of_visit }}.\n\n{{ patient_summary }}\n\nWrite careful notes about your visit with {{ first_name }},\nas Dr. {{ doctor_sampler.first_name }} {{ doctor_sampler.last_name }}.\n\nFormat the notes as a busy doctor might.\nRespond with only the notes, no other text.\n\"\"\",\n        model_alias=MODEL_ALIAS,\n    )\n)\n\ndata_designer.validate(config_builder)",
      "language": "python"
    },
    {
      "type": "markdown",
      "source": "### \ud83d\udd01 Iteration is key \u2013\u00a0preview the dataset!\n\n1. Use the `preview` method to generate a sample of records quickly.\n\n2. Inspect the results for quality and format issues.\n\n3. Adjust column configurations, prompts, or parameters as needed.\n\n4. Re-run the preview until satisfied."
    },
    {
      "type": "code",
      "source": "preview = data_designer.preview(config_builder, num_records=2)",
      "language": "python"
    },
    {
      "type": "code",
      "source": "# Run this cell multiple times to cycle through the 2 preview records.\npreview.display_sample_record()",
      "language": "python"
    },
    {
      "type": "code",
      "source": "# The preview dataset is available as a pandas DataFrame.\npreview.dataset",
      "language": "python"
    },
    {
      "type": "markdown",
      "source": "### \ud83d\udcca Analyze the generated data\n\n- Data Designer automatically generates a basic statistical analysis of the generated data.\n\n- This analysis is available via the `analysis` property of generation result objects."
    },
    {
      "type": "code",
      "source": "# Print the analysis as a table.\npreview.analysis.to_report()",
      "language": "python"
    },
    {
      "type": "markdown",
      "source": "### \ud83c\udd99 Scale up!\n\n- Happy with your preview data?\n\n- Use the `create` method to submit larger Data Designer generation jobs."
    },
    {
      "type": "code",
      "source": "results = data_designer.create(config_builder, num_records=10, dataset_name=\"tutorial-3\")",
      "language": "python"
    },
    {
      "type": "code",
      "source": "# Load the generated dataset as a pandas DataFrame.\ndataset = results.load_dataset()\n\ndataset.head()",
      "language": "python"
    },
    {
      "type": "code",
      "source": "# Load the analysis results into memory.\nanalysis = results.load_analysis()\n\nanalysis.to_report()",
      "language": "python"
    },
    {
      "type": "markdown",
      "source": "## \u23ed\ufe0f Next Steps\n\nCheck out the following notebook to learn more about:\n\n- [Providing images as context](https://nvidia-nemo.github.io/DataDesigner/latest/notebooks/4-providing-images-as-context/)\n\n- [Generating images](https://nvidia-nemo.github.io/DataDesigner/latest/notebooks/5-generating-images/)"
    }
  ]
}