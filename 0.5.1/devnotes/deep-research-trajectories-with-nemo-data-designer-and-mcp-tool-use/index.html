
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://nvidia-nemo.github.io/DataDesigner/latest/devnotes/deep-research-trajectories-with-nemo-data-designer-and-mcp-tool-use/">
      
      
        <link rel="prev" href="../designing-data-designer-why-sdg-is-a-systems-problem/">
      
      
        <link rel="next" href="../archive/2026/">
      
      
        
      
      
      <link rel="icon" href="../../assets/palette-favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Deep Research Trajectories with NeMo Data Designer and MCP Tool Use - NeMo Data Designer</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Fira Code"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/style.css">
    
      <link rel="stylesheet" href="../../css/mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deep-research-trajectories-with-nemo-data-designer-and-mcp-tool-use" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're not viewing the latest version.
  <a href="../../..">
    <strong>Click here to go to latest.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),base=new URL("../.."),outdated=__md_get("__outdated",sessionStorage,base);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="NeMo Data Designer" class="md-header__button md-logo" aria-label="NeMo Data Designer" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M512 256v2.7c-.4 36.5-33.6 61.3-70.1 61.3H344c-26.5 0-48 21.5-48 48 0 3.4.4 6.7 1 9.9 2.1 10.2 6.5 20 10.8 29.9 6.1 13.8 12.1 27.5 12.1 42 0 31.8-21.6 60.7-53.4 62-3.5.1-7 .2-10.6.2-141.4 0-256-114.6-256-256S114.6 0 256 0s256 114.6 256 256m-384 32a32 32 0 1 0-64 0 32 32 0 1 0 64 0m0-96a32 32 0 1 0 0-64 32 32 0 1 0 0 64m160-96a32 32 0 1 0-64 0 32 32 0 1 0 64 0m96 96a32 32 0 1 0 0-64 32 32 0 1 0 0 64"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            NeMo Data Designer
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Deep Research Trajectories with NeMo Data Designer and MCP Tool Use
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/NVIDIA-NeMo/DataDesigner" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="NeMo Data Designer" class="md-nav__button md-logo" aria-label="NeMo Data Designer" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M512 256v2.7c-.4 36.5-33.6 61.3-70.1 61.3H344c-26.5 0-48 21.5-48 48 0 3.4.4 6.7 1 9.9 2.1 10.2 6.5 20 10.8 29.9 6.1 13.8 12.1 27.5 12.1 42 0 31.8-21.6 60.7-53.4 62-3.5.1-7 .2-10.6.2-141.4 0-256-114.6-256-256S114.6 0 256 0s256 114.6 256 256m-384 32a32 32 0 1 0-64 0 32 32 0 1 0 64 0m0-96a32 32 0 1 0 0-64 32 32 0 1 0 0 64m160-96a32 32 0 1 0-64 0 32 32 0 1 0 64 0m96 96a32 32 0 1 0 0-64 32 32 0 1 0 0 64"/></svg>

    </a>
    NeMo Data Designer
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/NVIDIA-NeMo/DataDesigner" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/columns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Columns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/seed-datasets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Seed Datasets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/models/default-model-settings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Default Model Settings
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/models/configure-model-settings-with-the-cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configure with the CLI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/models/custom-model-settings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom Model Settings
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/models/model-providers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Providers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/models/model-configs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Configs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/models/inference-parameters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inference Parameters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/custom_columns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom Columns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/validators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Validators
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/processors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Processors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/person_sampling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Person Sampling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/traces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Traces
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tool Use & MCP
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tool Use & MCP
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/tool_use_and_mcp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/mcp/mcp-providers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MCP Providers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/mcp/tool-configs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tool Configs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/mcp/enabling-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Enabling Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/mcp/configure-mcp-cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/mcp/safety-and-limits/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Safety & Limits
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/architecture-and-performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture & Performance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/deployment-options/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment Options
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../notebooks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/1-the-basics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    The Basics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/2-structured-outputs-and-jinja-expressions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Structured Outputs and Jinja Expressions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/3-seeding-with-a-dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Seeding with an External Dataset
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/4-providing-images-as-context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Providing Images as Context
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/5-generating-images/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Generating Images
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/6-editing-images-with-image-context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Image-to-Image Editing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Recipes
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Recipes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recipes/cards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Recipe Cards
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Code Generation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Code Generation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recipes/code_generation/text_to_python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Text to Python
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recipes/code_generation/text_to_sql/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Text to SQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    QA and Chat
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    QA and Chat
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recipes/qa_and_chat/product_info_qa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Product Info QA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recipes/qa_and_chat/multi_turn_chat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Turn Chat
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    MCP and Tool Use
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    MCP and Tool Use
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recipes/mcp_and_tooluse/basic_mcp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Basic MCP Tool Use
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../recipes/mcp_and_tooluse/pdf_qa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PDF Document QA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Plugins
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Plugins
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plugins/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plugins/example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Example Plugin
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plugins/available/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Available Plugin List
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Code Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Code Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_reference/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_reference/mcp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    mcp
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_reference/column_configs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    column_configs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_reference/config_builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    config_builder
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_reference/data_designer_config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    data_designer_config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_reference/run_config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    run_config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_reference/sampler_params/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    sampler_params
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_reference/validator_params/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    validator_params
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_reference/processors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    processors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code_reference/analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Dev Notes
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Dev Notes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../designing-data-designer-why-sdg-is-a-systems-problem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Designing Data Designer: Why SDG Is a Systems Problem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../graduate-level-science-reasoning-data-with-nemo-data-designer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Graduate-Level Science Reasoning Data with NeMo Data Designer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Deep Research Trajectories with NeMo Data Designer and MCP Tool Use
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Deep Research Trajectories with NeMo Data Designer and MCP Tool Use
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-building-the-retrieval-mcp-server" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Building the Retrieval MCP Server
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-building-the-corpus" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Building the Corpus
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-the-data-designer-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 3: The Data Designer Pipeline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-rejection-sampling-with-an-llm-judge" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 4: Rejection Sampling with an LLM Judge
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-turn-tool-calling-rough-edges-in-the-open-model-ecosystem" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-Turn Tool Calling: Rough Edges in the Open Model Ecosystem
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Results
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#closing-remarks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Closing Remarks
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-for-yourself" class="md-nav__link">
    <span class="md-ellipsis">
      
        Try For Yourself
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_5" >
        
          
          <label class="md-nav__link" for="__nav_7_5" id="__nav_7_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../archive/2026/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2026
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-building-the-retrieval-mcp-server" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Building the Retrieval MCP Server
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-building-the-corpus" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Building the Corpus
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-the-data-designer-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 3: The Data Designer Pipeline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-rejection-sampling-with-an-llm-judge" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 4: Rejection Sampling with an LLM Judge
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-turn-tool-calling-rough-edges-in-the-open-model-ecosystem" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-Turn Tool Calling: Rough Edges in the Open Model Ecosystem
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Results
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#closing-remarks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Closing Remarks
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-for-yourself" class="md-nav__link">
    <span class="md-ellipsis">
      
        Try For Yourself
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="https://avatars.githubusercontent.com/u/1223539?v=4" alt="Eric Tramel">
                    </span>
                    <span class="md-profile__description">
                      <strong>
                        
                          Eric Tramel
                        
                      </strong>
                      <br>
                      Researcher at NVIDIA
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2026-02-10 00:00:00+00:00" class="md-ellipsis">February 10, 2026</time>
                      </div>
                    </li>
                    
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              20 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  



  
  


<h1 id="deep-research-trajectories-with-nemo-data-designer-and-mcp-tool-use"><strong>Deep Research Trajectories with NeMo Data Designer and MCP Tool Use</strong></h1>
<p>Data Designer <a href="https://github.com/NVIDIA-NeMo/DataDesigner/releases/tag/v0.5.0">v0.5.0</a>'s MCP <a href="../../concepts/tool_use_and_mcp/">tool-use support</a> lets you generate multi-turn research trajectories, the kind of data needed to train deep research agents that iteratively search, read, and synthesize evidence before answering a question.</p>
<!-- more -->

<hr />
<p><img align="right" alt="OpenResearcher benchmark results across deep research tasks. Source: Li, Jiang, Ma et al., 2026." src="https://huggingface.co/OpenResearcher/OpenResearcher-30B-A3B/resolve/main/imgs/teaser.png" width="500" /></p>
<p>Deep research agents like <a href="https://github.com/TIGER-AI-Lab/OpenResearcher">OpenResearcher</a> (Li, Jiang, Ma et al., 2026) and <a href="https://arxiv.org/abs/2509.00244">Universal Deep Research</a> (Belcak &amp; Molchanov, 2025) generate long reasoning chains interleaved with tool calls: formulating queries, retrieving documents, reading passages, refining hypotheses, and eventually synthesizing an answer. Training these agents requires trajectory data capturing the full multi-turn interaction between a model and its tools: every search, every document opened, every dead end explored.</p>
<p>OpenResearcher demonstrated something worth paying attention to: synthetic trajectories generated against a <em>local</em> retriever (<a href="https://dl.acm.org/doi/abs/10.1561/1500000019">BM25</a> over a static corpus, no web APIs) are sufficient to train <a href="https://huggingface.co/nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-BF16">Nemotron Nano 3</a> to outperform GPT-4.1 on deep research benchmarks. The data format (complete tool-use traces showing how a model moves through an information space) matters more than model scale. Nemotron Nano 3, with only 3B active parameters, beats models orders of magnitude larger on multi-hop research tasks.</p>
<p>This post shows how to generate that same kind of training data using Data Designer's MCP tool-use capabilities. We build a retriever as an MCP server, construct a corpus with known-good evidence, run a teacher model through the full research process, and use an LLM judge for rejection sampling. The result is a pipeline that produces high-quality research trajectories you can use for supervised fine-tuning or as a starting point for RL.</p>
<p>Here's what one of those trajectories looks like, a 4-hop question answered correctly by Claude Opus 4.5 using the pipeline described below. Each line is a tool call; parallel calls within the same turn are grouped.</p>
<details open>
<summary><strong>Example trajectory: 4-hop question, 31 turns, 49 tool calls</strong></summary>

<div class="trajectory-viz">
<style>
.trajectory-viz {
  font-family: -apple-system, system-ui, sans-serif;
  max-width: 960px;
  margin: 16px 0;
  padding: 0;
}
.trajectory-viz .tv-question {
  background: rgba(66, 165, 245, 0.08);
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 8px;
}
.trajectory-viz .tv-question strong {
  color: #42a5f5;
}
.trajectory-viz .tv-ref {
  background: rgba(76, 175, 80, 0.08);
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid #4caf50;
}
.trajectory-viz .tv-ref strong {
  color: #66bb6a;
}
.trajectory-viz .tv-turn {
  margin: 6px 0;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}
.trajectory-viz .tv-label {
  min-width: 48px;
  padding: 6px 0;
  opacity: 0.5;
  font-size: 0.75em;
  font-family: "SF Mono", Menlo, Monaco, "Cascadia Code", monospace;
  text-align: right;
  flex-shrink: 0;
}
.trajectory-viz .tv-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.trajectory-viz .tv-group {
  display: flex;
  flex-direction: column;
  gap: 3px;
  position: relative;
}
.trajectory-viz .tv-group.multi {
  padding-left: 13px;
}
.trajectory-viz .tv-group.multi::before {
  content: "";
  position: absolute;
  left: 0;
  top: 4px;
  bottom: 4px;
  width: 3px;
  background: rgba(128, 128, 128, 0.3);
  border-radius: 2px;
}
.trajectory-viz .tv-call {
  padding: 5px 12px;
  border-radius: 5px;
  font-family: "SF Mono", Menlo, Monaco, "Cascadia Code", monospace;
  font-size: 0.82em;
  display: flex;
  gap: 8px;
}
.trajectory-viz .tv-call .tv-fn {
  font-weight: bold;
  min-width: 55px;
  flex-shrink: 0;
}
.trajectory-viz .tv-call .tv-arg {
  opacity: 0.85;
}
.trajectory-viz .tv-call.tv-search {
  background: rgba(66, 165, 245, 0.1);
  border-left: 3px solid #42a5f5;
}
.trajectory-viz .tv-call.tv-search .tv-fn { color: #42a5f5; }
.trajectory-viz .tv-call.tv-open {
  background: rgba(102, 187, 106, 0.1);
  border-left: 3px solid #66bb6a;
}
.trajectory-viz .tv-call.tv-open .tv-fn { color: #66bb6a; }
.trajectory-viz .tv-call.tv-find {
  background: rgba(255, 167, 38, 0.1);
  border-left: 3px solid #ffa726;
}
.trajectory-viz .tv-call.tv-find .tv-fn { color: #ffa726; }
.trajectory-viz .tv-final {
  background: rgba(76, 175, 80, 0.08);
  border-left: 3px solid #4caf50;
  padding: 10px 16px;
  border-radius: 6px;
  font-size: 0.88em;
  line-height: 1.5;
}
.trajectory-viz .tv-final .tv-fn {
  color: #4caf50;
  font-weight: bold;
  font-family: "SF Mono", Menlo, Monaco, "Cascadia Code", monospace;
}
</style>

<div class="tv-question"><strong>Q:</strong> Who was the mother of the person under whom the colonizer of the winner of a border war with Libya in the 1st century BC reached its greatest extent?</div>
<div class="tv-ref"><strong>Reference:</strong> Marcia</div>
<div style="opacity: 0.5; font-size: 0.8em; margin-bottom: 12px;"> = golden passage (contains evidence for the answer)</div>

<div class="tv-turn"><div class="tv-label">T1</div><div class="tv-body"><div class="tv-group"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"border war Libya 1st century BC"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T2</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"ancient Egypt Libya war conflict 1st century BC"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Cyrene Libya ancient war border"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T3</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Ptolemaic Egypt Cyrenaica war conflict"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Egypt border war ancient 1st century BC winner"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T4</div><div class="tv-body"><div class="tv-group"><div class="tv-call tv-open"><span class="tv-fn">open</span><span class="tv-arg">md_001400</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T5</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Egypt Marmarica border war ancient Roman"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Marmaric War Egypt Libya ancient"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T6</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Greek colony Libya border war Cyrene colonization"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Thera Cyrene colony Greek colonization ancient"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T7</div><div class="tv-body"><div class="tv-group"><div class="tv-call tv-open"><span class="tv-fn">open</span><span class="tv-arg">md_000167</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T8</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"1st century BC war border Libya Egypt conflict"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Chad Libya border war Aouzou Strip conflict"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T9</div><div class="tv-body"><div class="tv-group"><div class="tv-call tv-open"><span class="tv-fn">open</span><span class="tv-arg">md_001676 </span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T10</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Roman Empire war Libya Numidia Africa ancient"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Jugurthine War Numidia Rome Libya"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T11</div><div class="tv-body"><div class="tv-group"><div class="tv-call tv-open"><span class="tv-fn">open</span><span class="tv-arg">fw_021746</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T12</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Egypt ancient war tribes Libya Marmaridae border conflict"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Cornelius Gallus Egypt prefect war border"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T13</div><div class="tv-body"><div class="tv-group"><div class="tv-call tv-open"><span class="tv-fn">open</span><span class="tv-arg">md_001054 </span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T14</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Roman Empire greatest extent Trajan mother"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Trajan Roman Empire greatest territorial extent"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T15</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-open"><span class="tv-fn">open</span><span class="tv-arg">md_002075 </span></div><div class="tv-call tv-open"><span class="tv-fn">open</span><span class="tv-arg">md_002510 </span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T16</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Egypt Roman province colony Augustus annexed"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Trajan mother Marcia family"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T17</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-open"><span class="tv-fn">open</span><span class="tv-arg">md_002117</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Trajan mother Marcia parents father"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T18</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Ulpia Marciana Trajan sister mother family"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Egypt war Libya Marmaricae ancient Roman"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T19</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Marcia Trajan Roman empress mother emperor"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Egypt Marmaric war ancient Rome Cyrene 1st century"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T20</div><div class="tv-body"><div class="tv-group"><div class="tv-call tv-open"><span class="tv-fn">open</span><span class="tv-arg">md_000722</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T21</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Ptolemaic Egypt border war Cyrene Cyrenaica territory"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Egypt vs Libya ancient war Ptolemy Rome colony"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T22</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Toyota War Chad Libya border winner conflict"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Chad Aouzou Strip war Libya France colonized"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T23</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"1st century BC Egypt border war defeat victory Rome colonize"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"ancient Egypt war won Libya 1st century BC Rome province"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T24</div><div class="tv-body"><div class="tv-group"><div class="tv-call tv-open"><span class="tv-fn">open</span><span class="tv-arg">md_002076 </span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T25</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"French Empire greatest extent Napoleon mother"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"France Vichy border war Libya Chad colonial"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T26</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Egypt war 25 BC 30 BC Marmaridae tribe Roman conquest"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Cornelius Balbus Garamantes Libya war Roman conquest"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T27</div><div class="tv-body"><div class="tv-group multi"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"ancient Crete war Libya border Greek colonize"</span></div><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Cyrene founded colonized by whom mother city Thera"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T28</div><div class="tv-body"><div class="tv-group"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Egypt Roman province colonized 1st century BC Trajan mother Marcia"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T29</div><div class="tv-body"><div class="tv-group"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Marcia Trajan mother Roman emperor name Ulpius"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T30</div><div class="tv-body"><div class="tv-group"><div class="tv-call tv-search"><span class="tv-fn">search</span><span class="tv-arg">"Egypt war border Libya Cyrenaica defeated 1st century BC Roman province"</span></div></div></div></div>
<div class="tv-turn"><div class="tv-label">T31</div><div class="tv-body"><div class="tv-final"><span class="tv-fn">answer</span><br>Based on my extensive research, I have gathered the following evidence:<br><br>1. <strong>The Roman Empire reached its greatest territorial extent under Trajan</strong> (117 CE)  confirmed by multiple documents<br>2. <strong>Trajan's mother was from the Gens Marcia</strong>  the Trajan document states he "on his mother's side from the Gens Marcia, of an Italic family of Sabine origin"<br>3. <strong>Egypt was colonized/annexed by Rome</strong> after Cleopatra's death (30 BC), making it a Roman province<br>4. <strong>Egypt had border conflicts with Libya (ancient Marmaricae/Cyrenaica region)</strong> in the 1st century BC<br><br>The answer is <strong>Marcia</strong>.</div></div></div>

</div>
</details>

<hr />
<h2 id="step-1-building-the-retrieval-mcp-server"><strong>Step 1: Building the Retrieval MCP Server</strong></h2>
<p>OpenResearcher's key design choice is a three-tool browser interface rather than a single retrieval call. The paper argues (and their ablations confirm) that separating search, document opening, and in-document search forces the model to develop genuine research strategies: skimming results, diving into promising documents, hunting for specific evidence within them. A single monolithic "retrieve" tool collapses this entire workflow into one step, which produces shorter and less useful training trajectories.</p>
<p>We implement the same three tools as an MCP server that Data Designer can invoke during generation. Our retriever uses <a href="https://github.com/xhluca/bm25s">BM25S</a> for fast lexical search over the corpus:</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mcp.server.fastmcp</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastMCP</span>

<span class="n">mcp_server</span> <span class="o">=</span> <span class="n">FastMCP</span><span class="p">(</span><span class="s2">&quot;corpus-retriever&quot;</span><span class="p">)</span>

<span class="nd">@mcp_server</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search for candidate documents to explore.&quot;&quot;&quot;</span>
    <span class="c1"># BM25S search over the corpus, returns ranked results with snippets</span>
    <span class="o">...</span>

<span class="nd">@mcp_server</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">open_document</span><span class="p">(</span><span class="n">doc_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open a document for detailed inspection with cursor-numbered chunks.&quot;&quot;&quot;</span>
    <span class="c1"># Returns content formatted as [1] paragraph... [2] paragraph...</span>
    <span class="o">...</span>

<span class="nd">@mcp_server</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span><span class="n">doc_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find matching passages inside a document by keyword.&quot;&quot;&quot;</span>
    <span class="c1"># Returns matching chunks with cursor positions</span>
    <span class="o">...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">mcp_server</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p><code>search</code> returns a ranked list of document IDs with short snippets, enough for the model to decide which documents look promising. <code>open</code> returns the full document content, split into cursor-numbered chunks so the model can reference specific passages. <code>find</code> does targeted keyword search <em>within</em> a single document, letting the model locate specific evidence without reading the entire thing. The cursor-based chunking across <code>open</code> and <code>find</code> gives the model a way to scan long documents incrementally, the way a human researcher would scan a paper for the relevant section rather than reading it cover to cover.</p>
<p>The server runs as a local stdio process, which means Data Designer launches and manages it automatically. No external services, no API keys for retrieval, no rate limits.</p>
<hr />
<h2 id="step-2-building-the-corpus"><strong>Step 2: Building the Corpus</strong></h2>
<p>The corpus design follows directly from OpenResearcher's most striking ablation result. They tested what happens when you vary the retrieval corpus while keeping the reasoning model fixed (GPT-OSS-120B). The results, from the <a href="https://boiled-honeycup-4c7.notion.site/Appendix-301e290627b58082abffd1ea2c262eb2">OpenResearcher Appendix</a>:</p>
<div style="display: flex; justify-content: center;">
<table>
<thead>
<tr>
<th style="text-align: left;">Corpus</th>
<th style="text-align: center;">BrowseComp-Plus Accuracy</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Golden passages only (BrowseComp-Plus corpus)</td>
<td style="text-align: center;">56.0%</td>
</tr>
<tr>
<td style="text-align: left;">15M FineWeb + golden passages</td>
<td style="text-align: center;">31.2%</td>
</tr>
<tr>
<td style="text-align: left;">15M FineWeb only</td>
<td style="text-align: center;">0.71%</td>
</tr>
</tbody>
</table>
</div>
<p>Without golden passages (documents known to contain evidence for the question), accuracy drops to nearly zero. The model can't learn research strategies from trajectories where every search is a dead end.</p>
<p>The original OpenResearcher corpus uses 15M documents from <a href="https://huggingface.co/datasets/HuggingFaceFW/fineweb">FineWeb</a> as distractors alongside 10K golden passages. For this demonstration, we use a lighter-weight approach: we construct the corpus from multi-hop QA datasets: <a href="https://arxiv.org/abs/1809.09600">HotpotQA</a> (2-hop questions requiring two pieces of linked evidence) and <a href="https://arxiv.org/abs/2108.00573">MuSiQue</a> (2-4 hop questions composed from single-hop sub-questions). Each question comes with annotated supporting passages, the specific paragraphs that contain the evidence needed to answer it. Golden passages go into the corpus alongside non-supporting passages from the same datasets as distractors, at roughly a 1:9 ratio. The model has to search through noise to find the signal, which is exactly the skill we want the training data to teach.</p>
<p>The key constraint is that golden passages must be <em>findable but not obvious</em>. If the corpus is too small or the golden passages are too easy to identify, the trajectories won't transfer to real-world research where evidence is sparse. The distractor ratio controls this difficulty, and the paper's ablations give us a good starting point for tuning it.</p>
<hr />
<h2 id="step-3-the-data-designer-pipeline"><strong>Step 3: The Data Designer Pipeline</strong></h2>
<p>With the retriever server and corpus ready, the Data Designer pipeline ties everything together. We configure a teacher model, point it at the MCP retriever, and let it research each question from scratch. For this demo we hosted our own inference server, but anyone can try this pipeline using <a href="https://build.nvidia.com/nvidia/nemotron-3-nano-30b-a3b">Nemotron Nano 3 on build.nvidia.com</a> with a free API key using the model configuration shown below.</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">data_designer.config</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_designer.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataDesigner</span>

<span class="c1"># Search rollout model for trajectory generation</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">DataDesignerConfigBuilder</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_model_config</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">ModelConfig</span><span class="p">(</span>
        <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;search_rollout_model&quot;</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;nvidia/nemotron-3-nano-30b-a3b&quot;</span><span class="p">,</span>
        <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;nvidia&quot;</span><span class="p">,</span>
        <span class="n">inference_parameters</span><span class="o">=</span><span class="n">dd</span><span class="o">.</span><span class="n">ChatCompletionInferenceParams</span><span class="p">(</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">top_p</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
            <span class="n">max_tokens</span><span class="o">=</span><span class="mi">16384</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>The temperature and top_p settings matter here. We want diverse research strategies across seeds (different query formulations, different document exploration orders) so that rejection sampling has a rich pool to select from. Setting temperature to 1.0 with top_p at 0.95 gives enough variation that the same question can produce meaningfully different trajectories across seeds.</p>
<p>The MCP tool configuration tells Data Designer which server to use and how many tool-call turns to allow:</p>
<div class="language-python highlight"><pre><span></span><code><span class="c1"># MCP retriever tool configuration</span>
<span class="n">tool_config</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">ToolConfig</span><span class="p">(</span>
    <span class="n">tool_alias</span><span class="o">=</span><span class="s2">&quot;knowledge-base&quot;</span><span class="p">,</span>
    <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;corpus-retriever&quot;</span><span class="p">],</span>
    <span class="n">max_tool_call_turns</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_tool_config</span><span class="p">(</span><span class="n">tool_config</span><span class="p">)</span>
</code></pre></div>
<p>We set <code>max_tool_call_turns</code> high (150) because deep research trajectories can be long. Our longest observed trajectory used 25 tool calls across 53 messages. Capping too low would truncate the most interesting research chains.</p>
<p>The seed dataset contains the research questions alongside reference answers (which we'll use for rejection sampling in Step 4):</p>
<div class="language-python highlight"><pre><span></span><code><span class="n">config</span><span class="o">.</span><span class="n">with_seed_dataset</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">LocalFileSeedSource</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;questions.jsonl&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">ExpressionColumnConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;research_question&quot;</span><span class="p">,</span>
        <span class="n">expr</span><span class="o">=</span><span class="s2">&quot;{{ question }}&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>The core of the pipeline is the research column, where the teacher model receives a question and a system prompt instructing it to use the retriever tools:</p>
<div class="language-python highlight"><pre><span></span><code><span class="n">SYSTEM_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are a thorough research assistant. You have access to three tools </span><span class="se">\</span>
<span class="s2">for navigating a knowledge base:</span>
<span class="s2">- search(query, top_k): Find candidate documents relevant to your query</span>
<span class="s2">- open(doc_id): Open a document to read its full content in numbered chunks</span>
<span class="s2">- find(doc_id, query): Locate specific passages within a document by keyword</span>

<span class="s2">Your task is to research the given question by searching for relevant documents, </span><span class="se">\</span>
<span class="s2">reading their content, and synthesizing an answer from the evidence you find. </span><span class="se">\</span>
<span class="s2">Be systematic: formulate search queries, explore promising results, and gather </span><span class="se">\</span>
<span class="s2">evidence before answering. Cite specific passages when possible.&quot;&quot;&quot;</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">LLMTextColumnConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;research_answer&quot;</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Research and answer thoroughly:</span><span class="se">\n\n</span><span class="s2">{{ research_question }}&quot;</span><span class="p">,</span>
        <span class="n">model_alias</span><span class="o">=</span><span class="s2">&quot;search_rollout_model&quot;</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="o">=</span><span class="n">SYSTEM_PROMPT</span><span class="p">,</span>
        <span class="n">tool_alias</span><span class="o">=</span><span class="s2">&quot;knowledge-base&quot;</span><span class="p">,</span>
        <span class="n">with_trace</span><span class="o">=</span><span class="n">dd</span><span class="o">.</span><span class="n">TraceType</span><span class="o">.</span><span class="n">ALL_MESSAGES</span><span class="p">,</span>
        <span class="n">extract_reasoning_content</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>Two settings are doing the important work here. <code>with_trace=dd.TraceType.ALL_MESSAGES</code> captures the <em>entire</em> interaction (every tool call, every tool response, every intermediate reasoning step) into a separate trace column in ChatML format. This is the training data: the full trajectory of how the model moved through the information space. <code>extract_reasoning_content=True</code> pulls out the model's internal chain-of-thought separately, so you can include or exclude it depending on your training setup.</p>
<hr />
<h2 id="step-4-rejection-sampling-with-an-llm-judge"><strong>Step 4: Rejection Sampling with an LLM Judge</strong></h2>
<p>Not every trajectory leads to a correct answer. OpenResearcher's approach is straightforward. Generate multiple trajectories per question, score them for correctness, and keep only the ones that got the right answer. We implement this with Data Designer's <code>LLMJudgeColumnConfig</code>, using a separate (smaller) model as the judge:</p>
<div class="language-python highlight"><pre><span></span><code><span class="c1"># Judge model for rejection sampling</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_model_config</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">ModelConfig</span><span class="p">(</span>
        <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;judge&quot;</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;nvidia/nemotron-3-nano-30b-a3b&quot;</span><span class="p">,</span>
        <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;nvidia&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">LLMJudgeColumnConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;correctness&quot;</span><span class="p">,</span>
        <span class="n">model_alias</span><span class="o">=</span><span class="s2">&quot;judge&quot;</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Question: {{ research_question }}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Reference answer: {{ answer }}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Generated answer: {{ research_answer }}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Does the generated answer correctly address the question?&quot;</span>
        <span class="p">),</span>
        <span class="n">scores</span><span class="o">=</span><span class="p">[</span>
            <span class="n">dd</span><span class="o">.</span><span class="n">Score</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;correct&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Is the answer factually correct?&quot;</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="p">{</span>
                    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Correct&quot;</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;Incorrect&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>The judge compares the generated answer against the reference answer from the seed dataset. Using a smaller model as judge is deliberate. We don't need the judge to <em>reason</em> about the question, just to compare two answers for factual agreement. This keeps costs down when scoring thousands of trajectories.</p>
<p>In practice, you'd generate multiple trajectories per question (varying the random seed) and filter to <code>correctness.correct == 1</code>. The incorrect trajectories aren't wasted; they can serve as negative examples for preference-based training methods like DPO.</p>
<hr />
<h2 id="multi-turn-tool-calling-rough-edges-in-the-open-model-ecosystem"><strong>Multi-Turn Tool Calling: Rough Edges in the Open Model Ecosystem</strong></h2>
<p>The pipeline described above is straightforward in principle. In practice, getting multi-turn tool calling to work reliably with open-weight models served through vLLM turned out to be the hardest part of this project.</p>
<p>We tested two open-weight models on a self-hosted <a href="https://github.com/vllm-project/vllm/releases/tag/v0.15.1">vLLM (v0.15.1)</a> instance: <a href="https://huggingface.co/openai/gpt-oss-120b">GPT-OSS-120B</a> and <a href="https://huggingface.co/moonshotai/Kimi-K2.5">Kimi K2.5</a>. Both failed to produce usable research trajectories, for related but distinct reasons.</p>
<p><strong>GPT-OSS-120B</strong> uses a <a href="https://cookbook.openai.com/articles/openai-harmony">"Harmony" output format</a> that routes text through named channels (reasoning, final answer, tool calls). When tools are involved, vLLM's parser consistently routes the model's output to the wrong channel: everything lands in <code>reasoning_content</code> while the <code>content</code> field stays empty. This happens at all <code>reasoning_effort</code> levels. The model does the research (calls tools, reads documents, formulates queries) but the final synthesized answer never appears where the serving layer expects it. This is a known issue in vLLM's Harmony format handling. Here's the final message from a typical trajectory. The model has been researching for 5 tool calls but produces no answer:</p>
<div class="language-json highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;text&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">}],</span>
<span class="w">  </span><span class="nt">&quot;reasoning_content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;It seems that the knowledge base may have a page about</span>
<span class="s2">    Colin Bateman that includes his biography. Possibly the &#39;md_001100&#39; entry is</span>
<span class="s2">    about a footballer, not the author. The author Colin Bateman likely ...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;tool_calls&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
<span class="p">}</span>
</code></pre></div>
<p>The model's reasoning shows it <em>has</em> the answer (it identified Colin Bateman as the author), but the content field is empty and no tool call is emitted. The trajectory ends here with nothing to show for it.</p>
<p><strong>Kimi K2.5</strong> exhibits a different failure mode. With its thinking mode enabled, it has the same channel-routing problem as GPT-OSS. With thinking mode disabled, the model produces content text, but after the first tool result, it <em>narrates</em> what it plans to do next rather than emitting another tool call. The serving layer sees text content without tool calls and treats it as the final answer, terminating the research loop after a single search:</p>
<div class="language-json highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;I found that &#39;Cycle of Violence&#39; was written by Colin Bateman,</span>
<span class="s2">    described as a &#39;Northern Irish author&#39;. Now let me search for more details</span>
<span class="s2">    about his birthplace to confirm his birth country.&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;reasoning_content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The search results clearly show that &#39;Cycle of Violence&#39;</span>
<span class="s2">    was written by Colin Bateman, a Northern Irish author...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;tool_calls&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
<span class="p">}</span>
</code></pre></div>
<p>The model intends to keep researching ("let me search for more details") but describes the action instead of calling the tool. The framework sees content, no tool calls, and stops. We tried multiple tokenizer modes, prompt variations, and vLLM configurations; open issues on the model's HuggingFace page confirm this is a broader compatibility gap.</p>
<p>The original OpenResearcher codebase handles this by bypassing vLLM's tool call parser entirely. They hit the raw <code>/completions</code> endpoint (<a href="https://github.com/TIGER-AI-Lab/OpenResearcher/blob/main/utils/openai_generator.py#L153-L177"><code>openai_generator.py</code></a>), parse <code>&lt;tool_call&gt;</code> XML tags from the output with regex, and continue looping until the model emits an explicit answer marker like <code>&lt;answer&gt;</code> or <code>final answer:</code> (<a href="https://github.com/TIGER-AI-Lab/OpenResearcher/blob/main/deploy_agent.py#L313-L407"><code>deploy_agent.py</code></a>).</p>
<p>The open-source tool-calling stack is growing and maturing quickly, but multi-turn tool use with reasoning models is still a rough edge. For now, the practical path is to use models with battle-tested tool-calling support through their native APIs, which is what we do in the results below.</p>
<hr />
<h2 id="results"><strong>Results</strong></h2>
<p>We ran 64 questions uniformly sampled across 2, 3, and 4-hop difficulty levels from MuSiQue, with 50K FineWeb web documents as distractors (a 1:100 golden-to-distractor ratio). We tested two models, Claude Opus 4.5 (via API) and Nemotron Nano 3 (30B total / 3B active params, self-hosted via vLLM with reasoning disabled).</p>
<div style="display: flex; justify-content: center;">
<table>
<thead>
<tr>
<th style="text-align: left;"></th>
<th style="text-align: center;">Claude Opus 4.5</th>
<th style="text-align: center;">Nemotron Nano 3</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Samples</strong></td>
<td style="text-align: center;">64 (55 completed)</td>
<td style="text-align: center;">64 (61 completed)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Overall accuracy</strong></td>
<td style="text-align: center;">41/55 (75%)</td>
<td style="text-align: center;">32/61 (52%)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2-hop accuracy</strong></td>
<td style="text-align: center;">18/23 (78%)</td>
<td style="text-align: center;">13/23 (57%)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>3-hop accuracy</strong></td>
<td style="text-align: center;">15/18 (83%)</td>
<td style="text-align: center;">11/22 (50%)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>4-hop accuracy</strong></td>
<td style="text-align: center;">8/14 (57%)</td>
<td style="text-align: center;">8/16 (50%)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Avg tool calls</strong></td>
<td style="text-align: center;">16.8</td>
<td style="text-align: center;">11.8</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Max tool calls</strong></td>
<td style="text-align: center;">57</td>
<td style="text-align: center;">63</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Avg messages per trajectory</strong></td>
<td style="text-align: center;">40.4</td>
<td style="text-align: center;">26.5</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Max messages per trajectory</strong></td>
<td style="text-align: center;">117</td>
<td style="text-align: center;">129</td>
</tr>
</tbody>
</table>
</div>
<p>Opus is 22 points more accurate, but Nano runs roughly 5x faster on self-hosted hardware. Both models show tool usage scaling with hop count. Nano uses fewer tools but achieves lower accuracy, with the largest gap on 2-hop questions (78% vs 57%). Splitting by correctness reveals the same pattern in both models: incorrect trajectories are longer.</p>
<p><strong>Claude Opus 4.5:</strong></p>
<div style="display: flex; justify-content: center;">
<table>
<thead>
<tr>
<th style="text-align: left;">Outcome</th>
<th style="text-align: center;">Hops</th>
<th style="text-align: center;">Count</th>
<th style="text-align: center;">Avg Tool Calls</th>
<th style="text-align: center;">Avg Messages</th>
<th style="text-align: center;">Avg Answer Length</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Correct</strong></td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">18</td>
<td style="text-align: center;">7.3</td>
<td style="text-align: center;">18.9</td>
<td style="text-align: center;">1,072 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">15</td>
<td style="text-align: center;">14.9</td>
<td style="text-align: center;">35.7</td>
<td style="text-align: center;">1,372 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">21.0</td>
<td style="text-align: center;">50.6</td>
<td style="text-align: center;">1,705 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>41</strong></td>
<td style="text-align: center;"><strong>12.8</strong></td>
<td style="text-align: center;"><strong>31.2</strong></td>
<td style="text-align: center;"><strong>1,305 chars</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Incorrect</strong></td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">21.0</td>
<td style="text-align: center;">48.6</td>
<td style="text-align: center;">1,534 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">25.7</td>
<td style="text-align: center;">63.0</td>
<td style="text-align: center;">1,795 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">36.0</td>
<td style="text-align: center;">85.2</td>
<td style="text-align: center;">1,903 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>14</strong></td>
<td style="text-align: center;"><strong>28.4</strong></td>
<td style="text-align: center;"><strong>67.4</strong></td>
<td style="text-align: center;"><strong>1,748 chars</strong></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Nemotron Nano 3:</strong></p>
<div style="display: flex; justify-content: center;">
<table>
<thead>
<tr>
<th style="text-align: left;">Outcome</th>
<th style="text-align: center;">Hops</th>
<th style="text-align: center;">Count</th>
<th style="text-align: center;">Avg Tool Calls</th>
<th style="text-align: center;">Avg Messages</th>
<th style="text-align: center;">Avg Answer Length</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Correct</strong></td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">6.5</td>
<td style="text-align: center;">16.1</td>
<td style="text-align: center;">773 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">12.7</td>
<td style="text-align: center;">28.5</td>
<td style="text-align: center;">708 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">8.0</td>
<td style="text-align: center;">19.0</td>
<td style="text-align: center;">1,600 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>32</strong></td>
<td style="text-align: center;"><strong>9.0</strong></td>
<td style="text-align: center;"><strong>21.1</strong></td>
<td style="text-align: center;"><strong>957 chars</strong></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Incorrect</strong></td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">10.1</td>
<td style="text-align: center;">23.2</td>
<td style="text-align: center;">799 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">18.0</td>
<td style="text-align: center;">39.0</td>
<td style="text-align: center;">1,163 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">16.2</td>
<td style="text-align: center;">35.5</td>
<td style="text-align: center;">848 chars</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: center;"><strong>All</strong></td>
<td style="text-align: center;"><strong>29</strong></td>
<td style="text-align: center;"><strong>14.8</strong></td>
<td style="text-align: center;"><strong>32.6</strong></td>
<td style="text-align: center;"><strong>951 chars</strong></td>
</tr>
</tbody>
</table>
</div>
<p>Correct trajectories are shorter at every hop level for both models. Incorrect trajectories are roughly twice as long because the model keeps searching when it can't find evidence, then writes a longer answer to compensate. This anti-correlation between trajectory length and correctness is consistent across model scales, which means trajectory length alone could serve as a lightweight filter during rejection sampling.</p>
<hr />
<h2 id="closing-remarks"><strong>Closing Remarks</strong></h2>
<p>Thanks to the <a href="https://github.com/TIGER-AI-Lab/OpenResearcher">OpenResearcher</a> team for their work showing that synthetic research trajectories over local retrieval can train small models to compete with much larger ones. Their results suggest we're only beginning to understand how LLMs interact with search tools and how the structure of those interactions shapes what models learn. We're excited to see where the community takes synthetic data research using <a href="https://github.com/NVIDIA-NeMo/DataDesigner">NeMo Data Designer</a> as both the models and the tooling continue to improve.</p>
<hr />
<h2 id="try-for-yourself"><strong>Try For Yourself</strong></h2>
<details>
<summary><strong>Full source: <code>openresearcher_demo.py</code></strong></summary>
<div class="language-python highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">data_designer.config</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_designer.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataDesigner</span>

<span class="c1"># Models</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">DataDesignerConfigBuilder</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_model_config</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">ModelConfig</span><span class="p">(</span>
        <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;search_rollout_model&quot;</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;nvidia/nemotron-3-nano-30b-a3b&quot;</span><span class="p">,</span>
        <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;nvidia&quot;</span><span class="p">,</span>
        <span class="n">inference_parameters</span><span class="o">=</span><span class="n">dd</span><span class="o">.</span><span class="n">ChatCompletionInferenceParams</span><span class="p">(</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">top_p</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
            <span class="n">max_tokens</span><span class="o">=</span><span class="mi">16384</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_model_config</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">ModelConfig</span><span class="p">(</span>
        <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;judge&quot;</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;nvidia/nemotron-3-nano-30b-a3b&quot;</span><span class="p">,</span>
        <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;nvidia&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># MCP retriever</span>
<span class="n">tool_config</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">ToolConfig</span><span class="p">(</span>
    <span class="n">tool_alias</span><span class="o">=</span><span class="s2">&quot;knowledge-base&quot;</span><span class="p">,</span>
    <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;corpus-retriever&quot;</span><span class="p">],</span>
    <span class="n">max_tool_call_turns</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_tool_config</span><span class="p">(</span><span class="n">tool_config</span><span class="p">)</span>

<span class="c1"># Seed questions with reference answers</span>
<span class="n">config</span><span class="o">.</span><span class="n">with_seed_dataset</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">LocalFileSeedSource</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;questions.jsonl&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">ExpressionColumnConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;research_question&quot;</span><span class="p">,</span>
        <span class="n">expr</span><span class="o">=</span><span class="s2">&quot;{{ question }}&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Research trajectory generation</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">LLMTextColumnConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;research_answer&quot;</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Research and answer thoroughly:</span><span class="se">\n\n</span><span class="s2">{{ research_question }}&quot;</span><span class="p">,</span>
        <span class="n">model_alias</span><span class="o">=</span><span class="s2">&quot;search_rollout_model&quot;</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="o">=</span><span class="n">SYSTEM_PROMPT</span><span class="p">,</span>
        <span class="n">tool_alias</span><span class="o">=</span><span class="s2">&quot;knowledge-base&quot;</span><span class="p">,</span>
        <span class="n">with_trace</span><span class="o">=</span><span class="n">dd</span><span class="o">.</span><span class="n">TraceType</span><span class="o">.</span><span class="n">ALL_MESSAGES</span><span class="p">,</span>
        <span class="n">extract_reasoning_content</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Rejection sampling judge</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
    <span class="n">dd</span><span class="o">.</span><span class="n">LLMJudgeColumnConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;correctness&quot;</span><span class="p">,</span>
        <span class="n">model_alias</span><span class="o">=</span><span class="s2">&quot;judge&quot;</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Question: {{ research_question }}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Reference answer: {{ answer }}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Generated answer: {{ research_answer }}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Does the generated answer correctly address the question?&quot;</span>
        <span class="p">),</span>
        <span class="n">scores</span><span class="o">=</span><span class="p">[</span>
            <span class="n">dd</span><span class="o">.</span><span class="n">Score</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;correct&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Is the answer factually correct?&quot;</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="p">{</span>
                    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Correct&quot;</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;Incorrect&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">),</span>
        <span class="p">],</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Run</span>
<span class="n">mcp_provider</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">LocalStdioMCPProvider</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;corpus-retriever&quot;</span><span class="p">,</span>
    <span class="n">command</span><span class="o">=</span><span class="s2">&quot;uv&quot;</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;retriever_mcp.py&quot;</span><span class="p">,</span> <span class="s2">&quot;serve&quot;</span><span class="p">],</span>
    <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;CORPUS_PATH&quot;</span><span class="p">:</span> <span class="s2">&quot;corpus.jsonl&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">data_designer</span> <span class="o">=</span> <span class="n">DataDesigner</span><span class="p">(</span><span class="n">mcp_providers</span><span class="o">=</span><span class="p">[</span><span class="n">mcp_provider</span><span class="p">])</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">data_designer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">config_builder</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="n">num_records</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">dataset_name</span><span class="o">=</span><span class="s2">&quot;research-trajectories&quot;</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
</details>
<details>
<summary><strong>Full source: <code>prepare_corpus.py</code></strong></summary>
<div class="language-python highlight"><pre><span></span><code><span class="c1"># /// script</span>
<span class="c1"># requires-python = &quot;&gt;=3.10&quot;</span>
<span class="c1"># dependencies = [&quot;datasets&quot;, &quot;huggingface_hub&quot;, &quot;pyarrow&quot;]</span>
<span class="c1"># ///</span>

<span class="sd">&quot;&quot;&quot;Prepare a retrieval corpus and question set for the OpenResearcher demo.</span>

<span class="sd">Builds corpus.jsonl and questions.jsonl from two sources:</span>

<span class="sd">    1. MuSiQue  multi-hop QA dataset (2/3/4-hop) with golden passages</span>
<span class="sd">    2. FineWeb  web documents as distractors (matches the OpenResearcher paper)</span>

<span class="sd">Golden passages (documents containing evidence for the answer) are mixed with</span>
<span class="sd">FineWeb distractors at roughly 1:100 ratio, so the model must search through</span>
<span class="sd">noise to find the signal.</span>

<span class="sd">Usage:</span>
<span class="sd">    uv run prepare_corpus.py</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>

<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Configuration</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<span class="n">NUM_QUESTIONS</span> <span class="o">=</span> <span class="mi">192</span>          <span class="c1"># 64 per hop level (2, 3, 4)</span>
<span class="n">NUM_FINEWEB_DISTRACTORS</span> <span class="o">=</span> <span class="mi">50_000</span>
<span class="n">FINEWEB_SHARD</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>

<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># MuSiQue extraction</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">prepare_musique</span><span class="p">(</span><span class="n">num_questions</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load MuSiQue and extract multi-hop questions with golden passages.</span>

<span class="sd">    Samples uniformly across hop counts (2, 3, 4) so the dataset has balanced</span>
<span class="sd">    difficulty. Golden passages (is_supporting=True) go into the corpus;</span>
<span class="sd">    non-golden passages from the same examples serve as additional distractors.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (questions, corpus_docs) where corpus_docs have is_golden=True/False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dataset</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading MuSiQue (train split)...&quot;</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;bdsaglam/musique&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>

    <span class="c1"># Bucket answerable examples by hop count</span>
    <span class="n">hop_buckets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">example</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;answerable&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">num_hops</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;question_decomposition&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="n">num_hops</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">hop_buckets</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">num_hops</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>

    <span class="c1"># Sample uniformly: equal questions per hop level</span>
    <span class="n">available_hops</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hop_buckets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">per_hop</span> <span class="o">=</span> <span class="n">num_questions</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_hops</span><span class="p">)</span>
    <span class="n">selected_examples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">available_hops</span><span class="p">:</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">hop_buckets</span><span class="p">[</span><span class="n">h</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">per_hop</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">))</span>
        <span class="n">selected_examples</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_examples</span><span class="p">)</span><span class="si">}</span><span class="s2"> questions across hops </span><span class="si">{</span><span class="n">available_hops</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Build questions and corpus docs</span>
    <span class="n">questions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">golden_titles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nongolden_titles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">selected_examples</span><span class="p">:</span>
        <span class="n">num_hops</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;question_decomposition&quot;</span><span class="p">])</span>
        <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;mq_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">questions</span><span class="p">)</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">],</span>
            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;answer&quot;</span><span class="p">],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;musique&quot;</span><span class="p">,</span>
            <span class="s2">&quot;num_hops&quot;</span><span class="p">:</span> <span class="n">num_hops</span><span class="p">,</span>
            <span class="s2">&quot;seed_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="k">for</span> <span class="n">para</span> <span class="ow">in</span> <span class="n">example</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;paragraphs&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">para</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">para</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;paragraph_text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">para</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_supporting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">golden_titles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)):</span>
                    <span class="n">golden_titles</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nongolden_titles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)):</span>
                    <span class="n">nongolden_titles</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>

    <span class="c1"># Golden passages</span>
    <span class="n">corpus_docs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;musique&quot;</span><span class="p">,</span> <span class="s2">&quot;is_golden&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">golden_titles</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="p">]</span>
    <span class="c1"># Non-golden passages (skip titles already in golden set)</span>
    <span class="n">corpus_docs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;musique&quot;</span><span class="p">,</span> <span class="s2">&quot;is_golden&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nongolden_titles</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">golden_titles</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Golden passages: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">golden_titles</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Non-golden passages: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus_docs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">golden_titles</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">questions</span><span class="p">,</span> <span class="n">corpus_docs</span>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># FineWeb distractor caching</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cache_fineweb</span><span class="p">(</span><span class="n">shard_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_docs</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download a FineWeb parquet shard and extract English documents.</span>

<span class="sd">    Uses huggingface_hub for direct shard download (faster than load_dataset)</span>
<span class="sd">    and pyarrow for memory-efficient row-group-at-a-time reading.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of distractor documents with title (domain) and content (text).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">huggingface_hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">hf_hub_download</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow.parquet</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sample/10BT/</span><span class="si">{</span><span class="n">shard_index</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">_00000.parquet&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading FineWeb shard: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">parquet_path</span> <span class="o">=</span> <span class="n">hf_hub_download</span><span class="p">(</span>
        <span class="n">repo_id</span><span class="o">=</span><span class="s2">&quot;HuggingFaceFW/fineweb&quot;</span><span class="p">,</span>
        <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">pf</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">ParquetFile</span><span class="p">(</span><span class="n">parquet_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">pf</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">num_rows</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> rows in shard&quot;</span><span class="p">)</span>

    <span class="n">docs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rg_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pf</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">num_row_groups</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">read_row_group</span><span class="p">(</span><span class="n">rg_idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="s2">&quot;token_count&quot;</span><span class="p">])</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">to_pydict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">tok_count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;token_count&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s2">&quot;en&quot;</span> <span class="ow">or</span> <span class="n">tok_count</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Use domain as title</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">netloc</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;www.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>

            <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">domain</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;fineweb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;is_golden&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_docs</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_docs</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Extracted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> English documents (min 50 tokens)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">docs</span>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Main</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">)</span>
    <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Extract MuSiQue questions and golden passages</span>
    <span class="n">questions</span><span class="p">,</span> <span class="n">corpus_docs</span> <span class="o">=</span> <span class="n">prepare_musique</span><span class="p">(</span><span class="n">NUM_QUESTIONS</span><span class="p">)</span>

    <span class="c1"># Download FineWeb distractors</span>
    <span class="n">fineweb_docs</span> <span class="o">=</span> <span class="n">cache_fineweb</span><span class="p">(</span><span class="n">FINEWEB_SHARD</span><span class="p">,</span> <span class="n">NUM_FINEWEB_DISTRACTORS</span><span class="p">)</span>
    <span class="n">corpus_docs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fineweb_docs</span><span class="p">)</span>

    <span class="c1"># Deduplicate by title (keep longest content)</span>
    <span class="n">title_to_best</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">corpus_docs</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">title_to_best</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">title_to_best</span><span class="p">[</span><span class="n">title</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]):</span>
            <span class="n">title_to_best</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span>

    <span class="n">corpus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">title_to_best</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">corpus</span><span class="p">)</span>

    <span class="c1"># Assign stable IDs</span>
    <span class="n">prefix_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;musique&quot;</span><span class="p">:</span> <span class="s2">&quot;md&quot;</span><span class="p">,</span> <span class="s2">&quot;fineweb&quot;</span><span class="p">:</span> <span class="s2">&quot;fw&quot;</span><span class="p">}</span>
    <span class="n">source_counters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">corpus</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="s2">&quot;xx&quot;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">source_counters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">idx</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">source_counters</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Write corpus.jsonl</span>
    <span class="n">corpus_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;corpus.jsonl&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">corpus_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">corpus</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Write questions.jsonl</span>
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">questions</span><span class="p">)</span>
    <span class="n">questions_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;questions.jsonl&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">questions_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Summary</span>
    <span class="n">golden</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">corpus</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;is_golden&quot;</span><span class="p">])</span>
    <span class="n">nongolden</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)</span> <span class="o">-</span> <span class="n">golden</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Corpus: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> docs (</span><span class="si">{</span><span class="n">golden</span><span class="si">}</span><span class="s2"> golden, </span><span class="si">{</span><span class="n">nongolden</span><span class="si">}</span><span class="s2"> distractors)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Questions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">questions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">corpus_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;         </span><span class="si">{</span><span class="n">questions_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
</details>
<details>
<summary><strong>Full source: <code>retriever_mcp.py</code></strong></summary>
<div class="language-python highlight"><pre><span></span><code><span class="c1"># /// script</span>
<span class="c1"># requires-python = &quot;&gt;=3.10&quot;</span>
<span class="c1"># dependencies = [&quot;mcp&quot;, &quot;bm25s&quot;, &quot;PyStemmer&quot;]</span>
<span class="c1"># ///</span>

<span class="sd">&quot;&quot;&quot;MCP Server: BM25S Corpus Retriever for OpenResearcher-style Deep Research</span>

<span class="sd">A single-file MCP server that indexes a JSONL corpus and exposes BM25S</span>
<span class="sd">lexical search via three browser tools:</span>

<span class="sd">    - search(query, top_k): ranked document discovery</span>
<span class="sd">    - open(doc_id): full document inspection with cursor-numbered chunks</span>
<span class="sd">    - find(doc_id, query): in-document evidence lookup</span>

<span class="sd">Corpus format (JSONL, one document per line):</span>
<span class="sd">    {&quot;id&quot;: &quot;wiki_123&quot;, &quot;title&quot;: &quot;Christopher Nolan&quot;, &quot;content&quot;: &quot;Christopher Edward Nolan is a...&quot;}</span>

<span class="sd">Server mode (used by Data Designer):</span>
<span class="sd">    CORPUS_PATH=corpus.jsonl uv run retriever_mcp.py serve</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">bm25s</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mcp.server.fastmcp</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastMCP</span>

<span class="n">MCP_SERVER_NAME</span> <span class="o">=</span> <span class="s2">&quot;corpus-retriever&quot;</span>

<span class="c1"># Global state  populated at server startup</span>
<span class="n">_bm25_retriever</span><span class="p">:</span> <span class="n">bm25s</span><span class="o">.</span><span class="n">BM25</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_corpus</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">_id_to_index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">mcp_server</span> <span class="o">=</span> <span class="n">FastMCP</span><span class="p">(</span><span class="n">MCP_SERVER_NAME</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_corpus</span><span class="p">(</span><span class="n">corpus_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a JSONL corpus file into a list of document dicts.&quot;&quot;&quot;</span>
    <span class="n">docs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">corpus_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: skipping malformed JSON at line </span><span class="si">{</span><span class="n">line_num</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">doc</span> <span class="ow">or</span> <span class="s2">&quot;content&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: skipping line </span><span class="si">{</span><span class="n">line_num</span><span class="si">}</span><span class="s2">, missing &#39;id&#39; or &#39;content&#39;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]),</span>
            <span class="p">})</span>
    <span class="k">return</span> <span class="n">docs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_index</span><span class="p">(</span><span class="n">docs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">bm25s</span><span class="o">.</span><span class="n">BM25</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a BM25S index over title + content for each document.&quot;&quot;&quot;</span>
    <span class="n">corpus_texts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">]</span>
    <span class="n">corpus_tokens</span> <span class="o">=</span> <span class="n">bm25s</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">corpus_texts</span><span class="p">,</span> <span class="n">stopwords</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="p">)</span>
    <span class="n">retriever</span> <span class="o">=</span> <span class="n">bm25s</span><span class="o">.</span><span class="n">BM25</span><span class="p">()</span>
    <span class="n">retriever</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">corpus_tokens</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retriever</span>


<span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">corpus_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load corpus and build index into global state.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_bm25_retriever</span><span class="p">,</span> <span class="n">_corpus</span><span class="p">,</span> <span class="n">_id_to_index</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading corpus from </span><span class="si">{</span><span class="n">corpus_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">_corpus</span> <span class="o">=</span> <span class="n">load_corpus</span><span class="p">(</span><span class="n">corpus_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_corpus</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: corpus is empty&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">_id_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_corpus</span><span class="p">)}</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building BM25S index over </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_corpus</span><span class="p">)</span><span class="si">}</span><span class="s2"> documents...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">_bm25_retriever</span> <span class="o">=</span> <span class="n">build_index</span><span class="p">(</span><span class="n">_corpus</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index ready. </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_corpus</span><span class="p">)</span><span class="si">}</span><span class="s2"> documents indexed.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_chunk_content</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split document content into cursor-addressable chunks.&quot;&quot;&quot;</span>
    <span class="n">paragraph_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\n\s*\n+&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraph_chunks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">paragraph_chunks</span>
    <span class="n">line_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">line_chunks</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">line_chunks</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">stripped</span><span class="p">]</span> <span class="k">if</span> <span class="n">stripped</span> <span class="k">else</span> <span class="p">[]</span>


<span class="nd">@mcp_server</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search for candidate documents to explore.</span>

<span class="sd">    Args:</span>
<span class="sd">        query: Search query string.</span>
<span class="sd">        top_k: Maximum number of ranked results (default: 10).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_bm25_retriever</span><span class="p">,</span> <span class="n">_corpus</span>
    <span class="k">if</span> <span class="n">_bm25_retriever</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">_corpus</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Search index not initialized&quot;</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">query_tokens</span> <span class="o">=</span> <span class="n">bm25s</span><span class="o">.</span><span class="n">tokenize</span><span class="p">([</span><span class="n">query</span><span class="p">],</span> <span class="n">stopwords</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">top_k</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_corpus</span><span class="p">)))</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">_bm25_retriever</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">query_tokens</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
    <span class="n">search_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">doc_idx</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">_corpus</span><span class="p">[</span><span class="n">doc_idx</span><span class="p">]</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">][:</span><span class="mi">500</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">snippet</span> <span class="o">+=</span> <span class="s2">&quot;...&quot;</span>
        <span class="n">search_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span>
            <span class="s2">&quot;snippet&quot;</span><span class="p">:</span> <span class="n">snippet</span><span class="p">,</span>
            <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">search_results</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">search_results</span><span class="p">)}</span>


<span class="nd">@mcp_server</span><span class="o">.</span><span class="n">tool</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">open_document</span><span class="p">(</span><span class="n">doc_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open a document for detailed inspection with cursor-numbered chunks.</span>

<span class="sd">    Args:</span>
<span class="sd">        doc_id: The document ID (from search results).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_corpus</span><span class="p">,</span> <span class="n">_id_to_index</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_corpus</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Corpus not loaded&quot;</span><span class="p">}</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_id_to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Document not found: </span><span class="si">{</span><span class="n">doc_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">_corpus</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="n">_chunk_content</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
    <span class="n">numbered_chunks</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;cursor&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">chunk</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">)]</span>
    <span class="n">formatted</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;cursor&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">numbered_chunks</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">formatted</span><span class="p">,</span>
        <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="n">numbered_chunks</span><span class="p">,</span>
        <span class="s2">&quot;total_chunks&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbered_chunks</span><span class="p">),</span>
    <span class="p">}</span>


<span class="nd">@mcp_server</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span><span class="n">doc_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find matching passages inside a document by keyword.</span>

<span class="sd">    Args:</span>
<span class="sd">        doc_id: Document ID to search within.</span>
<span class="sd">        query: Text to find (case-insensitive substring and keyword matching).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_corpus</span><span class="p">,</span> <span class="n">_id_to_index</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_corpus</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Corpus not loaded&quot;</span><span class="p">,</span> <span class="s2">&quot;matches&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">_id_to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Document not found: </span><span class="si">{</span><span class="n">doc_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;matches&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">query_text</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query_text</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Query must be non-empty&quot;</span><span class="p">,</span> <span class="s2">&quot;matches&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">_corpus</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="n">_chunk_content</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
    <span class="n">query_terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">term</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+&quot;</span><span class="p">,</span> <span class="n">query_text</span><span class="p">)</span> <span class="k">if</span> <span class="n">term</span><span class="p">]</span>
    <span class="n">matches</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">haystack</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">query_text</span> <span class="ow">in</span> <span class="n">haystack</span> <span class="ow">or</span> <span class="p">(</span><span class="n">query_terms</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span> <span class="ow">in</span> <span class="n">haystack</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">query_terms</span><span class="p">)):</span>
            <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;cursor&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">chunk</span><span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;doc_id&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
        <span class="s2">&quot;matches&quot;</span><span class="p">:</span> <span class="n">matches</span><span class="p">,</span>
        <span class="s2">&quot;total_matches&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span>
    <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">serve</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run as MCP server subprocess (called by Data Designer).&quot;&quot;&quot;</span>
    <span class="n">corpus_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CORPUS_PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;corpus.jsonl&quot;</span><span class="p">)</span>
    <span class="n">initialize</span><span class="p">(</span><span class="n">corpus_path</span><span class="p">)</span>
    <span class="n">mcp_server</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;BM25S corpus retriever MCP server&quot;</span><span class="p">)</span>
    <span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">dest</span><span class="o">=</span><span class="s2">&quot;command&quot;</span><span class="p">)</span>
    <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;serve&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run the MCP server (reads CORPUS_PATH from env)&quot;</span><span class="p">)</span>
    <span class="n">stats_parser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print corpus statistics&quot;</span><span class="p">)</span>
    <span class="n">stats_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--corpus-path&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;corpus.jsonl&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;serve&quot;</span><span class="p">:</span>
        <span class="n">serve</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;stats&quot;</span><span class="p">:</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="n">load_corpus</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">corpus_path</span><span class="p">)</span>
        <span class="n">total_chars</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corpus: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">corpus_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Documents: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total content: </span><span class="si">{</span><span class="n">total_chars</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> chars (~</span><span class="si">{</span><span class="n">total_chars</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">4</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> tokens)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
</code></pre></div>
</details>
<p>Key Resources:</p>
<ol>
<li><a href="https://github.com/NVIDIA-NeMo/DataDesigner">NeMo Data Designer on GitHub</a></li>
<li><a href="https://github.com/TIGER-AI-Lab/OpenResearcher">OpenResearcher on GitHub</a></li>
<li><a href="https://boiled-honeycup-4c7.notion.site/OpenResearcher-A-Fully-Open-Pipeline-for-Long-Horizon-Deep-Research-Trajectory-Synthesis-2f7e290627b5800cb3a0cd7e8d6ec0ea">OpenResearcher blog post</a></li>
<li><a href="https://arxiv.org/abs/1809.09600">HotpotQA: A Dataset for Diverse, Explainable Multi-hop Question Answering</a></li>
<li><a href="https://arxiv.org/abs/2108.00573">MuSiQue: Multi-hop Questions via Single-hop Question Composition</a></li>
<li><a href="https://github.com/xhluca/bm25s">BM25S: Fast lexical search in Python</a></li>
</ol>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../designing-data-designer-why-sdg-is-a-systems-problem/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Designing Data Designer: Why SDG Is a Systems Problem">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Designing Data Designer: Why SDG Is a Systems Problem
              </div>
            </div>
          </a>
        
        
          
          <a href="../archive/2026/" class="md-footer__link md-footer__link--next" aria-label="Next: 2026">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                2026
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.path", "navigation.footer", "navigation.indexes", "content.code.copy", "content.code.select", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"alias": true, "default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../js/toc-toggle.js"></script>
      
    
  </body>
</html>